---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(magrittr)
filename <-
  jsonlite::read_json("C:/Users/jacci/Documents/DS 710/coffee_roasting_profiles/data-raw/saved/Haiti--2021-02-09-20-15-17.json")
# filename2 <-
# jsonlite::toJSON("C:/Users/jacci/Documents/DS 710/coffee_roasting_profiles/data-raw/saved/Angola--2021-02-26-16-16-22.json")
```
```{r}
get_data_to_display_at_upload(filename)
get_special_event_times(filename) 
get_data_of_times_temps(filename) 
get_event_times(filename)
```
```{r put data in chart}
times <-
  get_data_of_times_temps(filename) %>%
  dplyr::mutate_if(is.character, as.numeric)#
special_times <- get_special_event_times(filename)
event_times <-
  get_event_times(filename) %>%
  dplyr::mutate_if(is.character, as.numeric)

    # Get data for certain parameters for chart
    time_zero = lubridate::as_datetime("1970-01-01 00:00:00 UTC")
    # time_max = max(as_datetime(profile$Time2), na.rm = TRUE)
    dry_end = lubridate::as_datetime(event_times$dry_time)
    first_crack_start = lubridate::as_datetime(event_times$fc_time_start)
    first_crack_end = lubridate::as_datetime(event_times$fc_time_end)
    second_crack_start = lubridate::as_datetime(event_times$sc_time_start)
    drop_time = lubridate::as_datetime(event_times$drop_time)
    max_temp = 500 # Highest temp in chart
plotly::plot_ly(
  # BT Line
  times,
  type = 'scatter',
  mode = 'lines',
  x = ~ lubridate::as_datetime(time),
  line = list(color = "#4DB848"),
  # x = ~seq(ms("00:00"), ms("10:10")),
  # x = ~ lubridate::ms(Time2),
  # x = ~ lubridate::as_datetime(Time1),
  y = ~ BT,
  # hovertemplate = paste('%{y: .1f}\u00b0F', '<br>%{x}<br>'),
  hovertemplate = '%{y: .1f}\u00b0F',
  showlegend = FALSE,
  name = "BT"
) %>%
  plotly::add_trace(
    times,
    # ET Line
    mode = 'lines',
    x = ~ lubridate::as_datetime(time),
    y = ~ ET,
    line = list(color = "#D50032"),
    name = "ET"
  ) %>%
  # add_trace(        # Change BT Line
  #   mode = 'lines',
  #   x = ~ lubridate::as_datetime(Time2),
  #   y = ~ change_BT,
  #   line = list(color = "#428BCA"),
  #   name = "\u0394BT",
  #   yaxis = "y2"
  # ) %>%
  plotly::layout(hovermode = "x unified") %>%
  # filter(!is.na(Event),
  #        !is.na(Time2),
  #        Event != "Drop",
  #        !grepl("^Charge", Event)) %>%
plotly::add_annotations(
  x =  ~lubridate::as_datetime(as.numeric(special_times$time_of_event)), # jitter() ?
  y = ~ 400,
  text = ~ special_times$type_of_event,
  # yaxis = "y2",
  textposition = "top center",
  showarrow = FALSE,
  # arrowhead = .5,
  # arrowwidth = 1,
  font = list(size = 12, color = "black")
  # bgcolor = ~ event_color
) %>%                     # Add lines for phases
plotly::add_segments(
  x = ~ dry_end,
  xend = ~ dry_end,
  y =  ~ 0,
  yend =  ~ max_temp,
  # opacity = 1,
  line = list(
    dash = "dash",
    color = '#AAAAAA',
    width = 2
  ),
  text = "Dry end"
) %>%
  plotly::add_segments(
    x = ~ first_crack_start,
    xend = ~ first_crack_start,
    y =  ~ 0,
    yend =  ~ max_temp,
    # opacity = 1,
    line = list(
      dash = "dash",
      color = '#AAAAAA',
      width = 2
    ),
    text = "FC start"
  ) %>%
  plotly::add_segments(
    x = ~ first_crack_end,
    xend = ~ first_crack_end,
    y =  ~ 0,
    yend =  ~ max_temp,
    # opacity = 1,
    line = list(
      dash = "dash",
      color = '#AAAAAA',
      width = 2
    ),
    text = "FC end"
  ) %>%
  # For second_crash_start
  # add_segments( x = ~first_crack_start, xend = ~first_crack_start, y =~ 0, yend=~500,
  #               # opacity = 1,
  #               line = list(dash="dash",
  #                           color = 'gray80',
  #                           width = 2), text = "FC start") %>%
  plotly::add_segments(
    x = ~ drop_time,
    xend = ~ drop_time,
    y =  ~ 0,
    yend =  ~ max_temp,
    # opacity = 1,
    line = list(
      dash = "dash",
      color = '#AAAAAA',
      width = 2
    ),
    text = "FC start"
  ) %>%
  plotly::layout(
    # The right side y-axis
    yaxis2 = list(
      zeroline = F,
      showline = F,
      showgrid = F,
      tickfont = list(color = "#428BCA"),
      ticksuffix = "\u00b0F",
      overlaying = "y",
      side = "right",
      title = ""
    ),
    xaxis = list(
      # gridcolor = toRGB("gray85"),
      title = "",
      zeroline = F,
      showline = F,
      showgrid = F,
      tick0 = time_zero,
      ticks = "inside",
      tickcolor = "rgb(245,245,245)",
      tickformat = "%M:%S",
      dtick = 30000 # Tick every 30 seconds
    ),
    yaxis = list(
      title = "",
      ticksuffix = "\u00b0F",
      zeroline = F,
      showline = F,
      showgrid = F
    ),
    margin = list(
      r = 30,
      l = 0,
      b = 0,
      t = 0
    ),
    plot_bgcolor = 'rgb(245,245,245)',
    # make grey background
    paper_bgcolor = 'rgb(245,245,245)'
  )
```
```{r}
# mess with format

x=lubridate::as_datetime(as.numeric(times$time))
lubridate::hms(x)
lubridate::minute(x)
lubridate::seconds(x)
lubridate::seconds_to_period(as.numeric(times$time)) %>% lubridate::ms() # THIS?
lubridate::fast_strptime(x, format = "%H%M")
(parse_date_time2(times$time))

sub(":\\d{2}", "", times((minutes%/%60 +  minutes%%60 /3600)/24))

as.numeric(times$time)%/%60  +  as.numeric(times$time)%%60 /3600


   plotly::plot_ly(
      # BT Line
      times,
      type = 'scatter',
      mode = 'lines',
      x = ~ lubridate::as_datetime(as.numeric(time)),
      line = list(color = "#4DB848"),
      # x = ~seq(ms("00:00"), ms("10:10")),
      # x = ~ lubridate::ms(Time2),
      # x = ~ lubridate::as_datetime(Time1),
      y = ~ BT,
      # hovertemplate = paste('%{y: .1f}\u00b0F', '<br>%{x}<br>'),
      hovertemplate = '%{y: .1f}\u00b0F',
      showlegend = FALSE,
      name = "BT"
    ) %>% plotly::layout(xaxis = list(tickformat = "%M:%S"))
```


